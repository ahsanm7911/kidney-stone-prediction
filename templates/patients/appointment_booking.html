{% extends "patients/base.html" %}
{% load static %}
{% block css %}<link rel="stylesheet" href="{% static "css/patients/appointment_booking.css" %}">{% endblock css %}
{% block title %}Book an Appointment{% endblock title %}
{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Book an Appointment</h4>
                </div>
                    <div class="card-body">
                        <form id="appointmentForm" enctype="multipart/form-data">
                            {% csrf_token %}
                            <!-- Doctor Selection -->
                            <div class="mb-4">
                                <h5>Choose a Doctor</h5>
                                <div class="mb-3">
                                    <label for="doctor" class="form-label">Select Doctor</label>
                                    <select class="form-select" id="doctor" required name="doctor_id">
                                        <option value="">Choose a doctor</option>
                                        {% for doctor in doctors %}
                                        <option value="{{ doctor.id }}">{{ doctor.user.get_full_name }} - {{ doctor.specialization}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Report Upload -->
                            <div class="mb-4">
                                <h5>Upload Medical Report</h5>
                                <div class="mb-3">
                                    <label for="report" class="form-label">Upload Report (PDF, DOC, IMG)</label>
                                    <input type="file" class="form-control" id="report" name="report"
                                    accept=".pdf,.doc,.docx,image/*">
                                </div>
                            </div>

                            <!-- Date Selection -->
                            <div class="mb-4">
                                <h5>Select Date</h5>
                                <div class="row" id="calendar">
                                    <!-- Calendar days will be generated by JavaScript -->
                                </div>
                            </div>
                            
                            <!-- Time Selection -->
                            <div class="mb-4" id="timeSelection" style="display: none;">
                                <h5>Select Time</h5>
                                <div class="d-flex flex-wrap" id="timeSlots">
                                    <!-- Time slots will be generated dynamically -->
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">Book Appointment</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
{% endblock content %}
{% block js %}
<script>
    const calendar = document.getElementById('calendar');
    const timeSelection = document.getElementById('timeSelection');
    const timeSlots = document.getElementById('timeSlots');
    const doctorSelect = document.getElementById('doctor');
    let selectedDate = null;
    let availableSlots = [];
    
    // Replace this with your actual Django endpoint
    const API_ENDPOINT = 'http://localhost:8000/api/available-slots/';
    
    function generateCalendar() {
        const today = new Date();
        for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            const dayDiv = document.createElement('div');
            dayDiv.className = 'col-2 calendar-day';
            dayDiv.innerHTML = `
            <div>${date.toLocaleString('default', { weekday: 'short' })}</div>
            <div>${date.getDate()}</div>
            `;
            dayDiv.dataset.date = date.toISOString().split('T')[0];
            dayDiv.addEventListener('click', selectDate);
            calendar.appendChild(dayDiv);
        }
    }
    
    function selectDate(e) {
        const selected = document.querySelector('.selected-day');
        if (selected) selected.classList.remove('selected-day');
        e.currentTarget.classList.add('selected-day');
        selectedDate = e.currentTarget.dataset.date;
        updateTimeSlots();
        timeSelection.style.display = 'block';
    }
    
    function updateTimeSlots() {
        timeSlots.innerHTML = '';
        const doctorId = doctorSelect.value;
        if (!doctorId || !selectedDate || !availableSlots[doctorId]) return;
        
        const slotsForDate = availableSlots[doctorId][selectedDate] || [];
        slotsForDate.forEach(time => {
            const btn = document.createElement('a');
            btn.className = 'btn btn-outline-primary time-slot';
            btn.textContent = time;
            btn.addEventListener('click', function(e) {
                const selected = timeSlots.querySelector('.selected');
                if (selected) selected.classList.remove('selected');
                this.classList.add('selected');
            });
            timeSlots.appendChild(btn);
        });
    }
    
    async function fetchDoctorAvailability(doctorId) {
        try {
            const response = await axios.get(`${API_ENDPOINT}${doctorId}/`, {
                headers: {
                    'Content-Type': 'application/json',
                    // Add any authentication headers if needed
                    // 'Authorization': 'Bearer your-token-here'
                }
            });
            console.log(response)
            // Assuming the response format is:
            // {
                //     "doctor_id": "dr_smith",
                //     "availability": {
                    //         "2024-02-22": ["09:00 AM", "10:00 AM", ...],
                    //         "2024-02-23": ["11:00 AM", "01:00 PM", ...],
                    //         ...
                    //     }
                    // }
                    availableSlots[doctorId] = response.data.availability;
                    if (selectedDate) updateTimeSlots();
                } catch (error) {
                    console.error('Error fetching availability:', error);
                    alert('Failed to load doctor availability');
                }
            }
            
            // Doctor selection change handler
            doctorSelect.addEventListener('change', function(e) {
                const doctorId = e.target.value;
                if (doctorId) {
                    fetchDoctorAvailability(doctorId);
                    timeSelection.style.display = 'none';
                    const selectedDay = document.querySelector('.selected-day');
                    if (selectedDay) selectedDay.classList.remove('selected-day');
                    selectedDate = null;
                }
            });
            
            // Form submission
            document.getElementById('appointmentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const doctor = doctorSelect.value;
                const report = document.getElementById('report').files[0]; 
                const selectedTime = timeSlots.querySelector('.selected')?.textContent;
                
                if (!doctor || !selectedDate || !selectedTime) {
                    alert('Please complete all fields: doctor, report, date, and time');
                    return;
                }
                bookAppointment(doctor, selectedDate, selectedTime, report)
            });
            
            // Initialize calendar
            generateCalendar();
            
            const bookAppointment = async (doctorId, date, time, reportFile=null) => {
                try {
                    // Get CSRF token from cookies 
                    const getCSRFToken = () => {
                        const cookies = document.cookie.split("; ")
                        for (let cookie of cookies) {
                            if (cookie.startsWith("csrftoken=")){
                                return cookie.split("=")[1]
                            }
                        }
                        return null;
                    }
                    
                    const csrfToken = getCSRFToken()
                    
                    // Convert 12-hour format to 24-hour format 
                    const formattedTime = convertTo24HourFormat(time)
                    console.log("Formatted Time", formattedTime)
                    // Create a FormData object for the request 
                    const formData = new FormData()
                    formData.append("doctor_id", doctorId)
                    formData.append("appointment_date", date)
                    formData.append("appointment_time", formattedTime) // Send time in '10:00 AM' format 
                    
                    // If a report file is provided, append it; otherwise, skip it
                    if (reportFile){
                        formData.append("report", reportFile)
                    } 
                    
                    console.log("Form Data: ", formData)
                    // Send POST request using Axios 
                    const response = await axios.post("http://localhost:8000/api/book-appointment/", formData, {
                        headers: {
                            "Content-Type": "multipart/form-data",
                            "X-CSRFToken": csrfToken
                        },
                        withCredentials: true,
                    })
                    console.log("Appointment booked successfully: ", response.data)
                } catch (error) {
                    console.error("Error booking appointment: ", error.response?.data || error.message)
                }
            }
            
            // Function to convert 12-hour format (10:00 AM) to 24-hour format (10:00:00)
            const convertTo24HourFormat = (timeStr) => {
                const [time, modifier] = timeStr.split(" ")
                let [hours, minutes] = time.split(":")
                if (modifier === "PM" && hours !== "12"){
                    hours = String(parseInt(hours, 10) + 12) // Convert PM times (except 12PM)
                } else if (modifier === "AM" && hours === "12"){
                    hours = "00" // Convert 12 AM to 00
                }
                return `${hours}:00:00` // add seconds
            }
        </script>
{% endblock js %}